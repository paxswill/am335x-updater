#!/bin/sh

set -e

# This is a systemd generator that creates the root mount file ("-.mount") for
# the nodes in a netbooting ARM cluster. It reads configuration from
# /etc/defaults/cluster-netboot (default values are also handled appropriately).

# Put another way, this is adding a little bit of smarts to
# systemd-fstab-generator, so that it also understands nfsroot= in addition to
# root= on the kernel command line.

OUTPUT_DIR="$1"

# The format for the nfsroot parameter, taken from nfsroot.txt from the kernel
# documentation:
# nfsroot=[<server-ip>:]<root-dir>[,<nfs-options>]
# * <server-ip> is determined from the `ip` command line parameter. The value
#   for <server-ip> is supposed to be available at /proc/net/pnp, prefixed with
#   "bootserver ".
# * <root-dir> is the directory on the server to mount at /. If there is a "%s"
#   in the string, it is replaced with "the ASCII-representation of the client's
#   IP address". The default value is "/tftpboot/%s"
# * <nfs-options> are standard NFS options, all separated by commas. The
#   defaults are listed in the kernel documentation.

# Debian does nfsroot a bit differently; instead of compiling in CONFIG_IP_PNP
# and CONFIG_ROOT_NFS, it's all done in initramfs. A consequence of this is
# that there is no /proc/net/pnp on these systems. Ubuntu on the other hand
# *does* include CONFIG_IP_PNP, but not CONFIG_ROOT_NFS. It also does the actual
# mounting of root from the initramfs.

# Assume the root FS is already mounted by now.
# TODO: Fix this so it can run in initramfs, where $ROOT_MOUNTPOINT is different
# before we've pivoted to it.
ROOT_MOUNTPOINT="/"
NFS_REGEX="^\([^ ]\+\) ${ROOT_MOUNTPOINT} nfs \(.*\) [0-9] [0-9]"
NFS_ROOT="$(grep -o -e "$NFS_REGEX" /proc/mounts)"
if [ "$NFS_ROOT" = "" ]; then
    echo "Root is not mounted over NFS, exiting."
    exit 0
fi

ROOT_MOUNT="$(echo "$NFSROOT" | sed s@"${NFS_REGEX}"@'\1'@)"
ROOT_OPTIONS="$(echo "$NFSROOT" | sed s@"${NFS_REGEX}"@'\2'@)"

cat >"${OUTPUT_DIR}/-.mount" <<EOF
# Automatically generated by cluster-root-mount-generator

[Unit]
Description=Declare the root mount point for a netbooted node in the cluster.
SourcePath=/proc/cmdline

[Mount]
Where=/
What=${ROOT_MOUNT}
Type=nfs
Options=${ROOT_OPTIONS}
EOF